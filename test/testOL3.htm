<!DOCTYPE html>
<html>
	<head>
		<title>testOL3</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" href="ol3/ol.css" type="text/css">
		<script src="ol3/ol.js"></script>
		<style>
			.map {
				height: 60%;
				width: 80%;
			}
			.zoom {
				height: 200px;
				width: 200px;
				top: 50px;
				left: 50px;
			}
			.cav {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0,0,0,0.5);
			}
		</style>
	</head>

	<body>
	<div id="map" class="map"></div>
	<div id="zoom"></div>
	</body>

	<script>
	// Map views always need a projection.	Here we just want to map image
	// coordinates directly to map coordinates, so we create a projection that uses
	// the image extent in pixels.

	var pj = new ol.proj.Projection({
		code: "EPSG :3857",
		extent: ol.proj.transformExtent ([-180, -85, 180, 85], ol.proj.get('EPSG:4326'), ol.proj.get('EPSG:3857')),
		worldExtent: [-180, -85, 180, 85],
		units: "m"
	});

	var ll = new ol.layer.Tile({
		source: new ol.source.OSM()
	});

	var img = new ol.layer.Image({
		source: new ol.source.ImageStatic({
			attributions: [
				new ol.Attribution({
					html: '&copy; <a href="http://xkcd.com/license.html">北京融昭普瑞科技有限公司</a>'
				})
			],
			// url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiVY7x///5/BjSgqKjIiC7GhC6ACwygQgxHMzAwMGDz4FDwDAD5/wevjSk4mwAAAABJRU5ErkJggg==",
			url: "../../../../../../../data/RegImg/test_bottom.png",
			projection: pj,
			imageExtent: ol.proj.transformExtent ([114.8232, 38.3107, 118.5672, 40.7607], ol.proj.get('EPSG:4326'), ol.proj.get('EPSG:3857'))
		}),
		opacity: 0.5
	});

	var data = [{"code":17018,"result":[
		{"zlevel":1,"grdCollection":[
			{
				"xIncrement":2.6265621185302734,
				"yIncrement":3.4224076271057129,
				"time":"2015-07-03 00",
				"x":116.17,
				"y":40.286499999999819,
				"speed":4.31,
				"angle":37.5
			},
			{"xIncrement":-0.76144367456436157,"yIncrement":4.8633098602294922,"time":"2015-07-03 01","x":116.29443488080955,"y":40.393153735676577,"speed":4.92,"angle":-8.9},{"xIncrement":-0.78967207670211792,"yIncrement":4.1467380523681641,"time":"2015-07-03 02","x":116.27722846765084,"y":40.555640446187311,"speed":4.22,"angle":-10.78},{"xIncrement":-1.249550461769104,"yIncrement":3.7789058685302734,"time":"2015-07-03 03","x":116.25642999335183,"y":40.694414645389763,"speed":3.98,"angle":-18.3},{"xIncrement":-1.0297703742980957,"yIncrement":1.9300153255462646,"time":"2015-07-03 04","x":116.2144354976175,"y":40.822081329480554,"speed":2.19,"angle":-28.08},{"xIncrement":-0.85726243257522583,"yIncrement":1.7426722049713135,"time":"2015-07-03 05","x":116.17594642166425,"y":40.8882008497605,"speed":1.94,"angle":-26.19},{"xIncrement":-0.46429914236068726,"yIncrement":1.5492045879364014,"time":"2015-07-03 06","x":116.14430342132469,"y":40.947697821001825,"speed":1.62,"angle":-16.68},{"xIncrement":-0.22894224524497986,"yIncrement":0.95139569044113159,"time":"2015-07-03 07","x":116.12908684076916,"y":40.999846640177921,"speed":0.98,"angle":-13.53},{"xIncrement":-0.72886145114898682,"yIncrement":0.41038376092910767,"time":"2015-07-03 08","x":116.12217771239645,"y":41.0317278077755,"speed":0.84,"angle":-60.62},{"xIncrement":-0.81709706783294678,"yIncrement":-0.3817371129989624,"time":"2015-07-03 09","x":116.09179575979726,"y":41.047001283317556,"speed":0.9,"angle":244.96},{"xIncrement":-0.61311262845993042,"yIncrement":-0.64079844951629639,"time":"2015-07-03 10","x":116.05504981598853,"y":41.036402724749969,"speed":0.89,"angle":223.74},{"xIncrement":-0.16984499990940094,"yIncrement":-0.79883736371994019,"time":"2015-07-03 11","x":116.02635959827036,"y":41.016776637996479,"speed":0.82,"angle":192.0},{"xIncrement":0.11782282590866089,"yIncrement":-0.91047376394271851,"time":"2015-07-03 12","x":116.01644760543974,"y":40.990877527736849,"speed":0.92,"angle":172.63},{"xIncrement":0.15170203149318695,"yIncrement":-0.667942225933075,"time":"2015-07-03 13","x":116.01868750674835,"y":40.960607428022996,"speed":0.68,"angle":167.2},{"xIncrement":-0.066693194210529327,"yIncrement":-0.17221452295780182,"time":"2015-07-03 14","x":116.02316517256472,"y":40.938240739365668,"speed":0.18,"angle":201.17},{"xIncrement":0.070133551955223083,"yIncrement":-0.26137307286262512,"time":"2015-07-03 15","x":116.01972311351848,"y":40.9327273581122,"speed":0.27,"angle":164.98},{"xIncrement":0.25795271992683411,"yIncrement":-0.0691169798374176,"time":"2015-07-03 16","x":116.02194279543635,"y":40.923948139098272,"speed":0.27,"angle":105.0},{"xIncrement":0.46406787633895874,"yIncrement":0.146079421043396,"time":"2015-07-03 17","x":116.03292836191291,"y":40.921051715548487,"speed":0.49,"angle":72.53},{"xIncrement":0.61201107501983643,"yIncrement":0.034764539450407028,"time":"2015-07-03 18","x":116.05354843642624,"y":40.924748526119792,"speed":0.61,"angle":86.75},{"xIncrement":0.72187972068786621,"yIncrement":-0.18897518515586853,"time":"2015-07-03 19","x":116.0802419542654,"y":40.924418777821714,"speed":0.75,"angle":104.67},{"xIncrement":1.3676778078079224,"yIncrement":-1.3845058679580688,"time":"2015-07-03 20","x":116.11099329944651,"y":40.9164480737964,"speed":1.95,"angle":135.35},{"xIncrement":2.6103479862213135,"yIncrement":-2.0858938694000244,"time":"2015-07-03 21","x":116.16594903921565,"y":40.867508460955627,"speed":3.34,"angle":128.63},{"xIncrement":3.4999570846557617,"yIncrement":-2.018214225769043,"time":"2015-07-03 22","x":116.27249694448894,"y":40.792367560489183,"speed":4.04,"angle":119.97},{"xIncrement":2.7478981018066406,"yIncrement":-2.5117919445037842,"time":"2015-07-03 23","x":116.41767103001521,"y":40.717147063905941,"speed":3.72,"angle":132.43}
		]},
		{"zlevel":2,"grdCollection":[
			{"xIncrement":-2.891998291015625,"yIncrement":6.7883892059326172,"time":"2015-07-03 00","x":116.17,"y":40.286499999999819,"speed":7.38,"angle":-23.08},{"xIncrement":-2.506594181060791,"yIncrement":5.5393152236938477,"time":"2015-07-03 01","x":116.0665849462104,"y":40.517816512603041,"speed":6.08,"angle":-24.35},{"xIncrement":-2.4547319412231445,"yIncrement":4.778505802154541,"time":"2015-07-03 02","x":115.97550086186651,"y":40.706658794449993,"speed":5.37,"angle":-27.19},{"xIncrement":-2.2571027278900146,"yIncrement":2.4392948150634766,"time":"2015-07-03 03","x":115.88396763996572,"y":40.870059710633278,"speed":3.32,"angle":-42.78},{"xIncrement":-0.11351987719535828,"yIncrement":0.44595533609390259,"time":"2015-07-03 04","x":115.79350335170366,"y":40.955754522291457,"speed":0.46,"angle":-14.28},{"xIncrement":0.21761861443519592,"yIncrement":0.16055002808570862,"time":"2015-07-03 05","x":115.78994895528083,"y":40.970711480869014,"speed":0.27,"angle":53.58},{"xIncrement":0.19681718945503235,"yIncrement":0.14654923975467682,"time":"2015-07-03 06","x":115.79990372381249,"y":40.975489875621435,"speed":0.25,"angle":53.33},{"xIncrement":0.86166715621948242,"yIncrement":0.008894035592675209,"time":"2015-07-03 07","x":115.80891190279642,"y":40.979855262734851,"speed":0.86,"angle":89.41},{"xIncrement":-0.71915543079376221,"yIncrement":0.28125408291816711,"time":"2015-07-03 08","x":115.84639069608284,"y":40.978121336246211,"speed":0.77,"angle":-68.64},{"xIncrement":-0.7606661319732666,"yIncrement":-0.43500092625617981,"time":"2015-07-03 09","x":115.81600559971022,"y":40.98907750356976,"speed":0.88,"angle":240.24},{"xIncrement":0.27066269516944885,"yIncrement":-1.2736395597457886,"time":"2015-07-03 10","x":115.7815962946773,"y":40.976533162906016,"speed":1.3,"angle":168.0},{"xIncrement":0.64676761627197266,"yIncrement":-1.5448318719863892,"time":"2015-07-03 11","x":115.78942244026216,"y":40.933940226812226,"speed":1.67,"angle":157.28},{"xIncrement":0.22395488619804382,"yIncrement":-1.0521563291549683,"time":"2015-07-03 12","x":115.81273575148667,"y":40.881515911558587,"speed":1.08,"angle":167.98},{"xIncrement":0.25377345085144043,"yIncrement":-0.79137885570526123,"time":"2015-07-03 13","x":115.81920068117023,"y":40.846309619396607,"speed":0.83,"angle":162.22},{"xIncrement":0.079333707690238953,"yIncrement":-0.21105870604515076,"time":"2015-07-03 14","x":115.82776334412954,"y":40.819623597251116,"speed":0.23,"angle":159.4},{"xIncrement":0.23528656363487244,"yIncrement":-0.17151208221912384,"time":"2015-07-03 15","x":115.83055192187776,"y":40.812478312007947,"speed":0.29,"angle":126.09},{"xIncrement":0.41922456026077271,"yIncrement":0.05598057433962822,"time":"2015-07-03 16","x":115.84022981147498,"y":40.8062690460391,"speed":0.42,"angle":82.39},{"xIncrement":0.62712490558624268,"yIncrement":0.26898449659347534,"time":"2015-07-03 17","x":115.85859449876043,"y":40.807125485798444,"speed":0.68,"angle":66.78},{"xIncrement":0.7845422625541687,"yIncrement":0.11058399826288223,"time":"2015-07-03 18","x":115.88664457089679,"y":40.814510462952953,"speed":0.79,"angle":81.98},{"xIncrement":1.00859797000885,"yIncrement":-0.26716324687004089,"time":"2015-07-03 19","x":115.9210343509051,"y":40.8162947417751,"speed":1.04,"angle":104.84},{"xIncrement":1.6328200101852417,"yIncrement":-1.4441189765930176,"time":"2015-07-03 20","x":115.9639610211144,"y":40.805084317474794,"speed":2.18,"angle":131.49},{"xIncrement":2.6932373046875,"yIncrement":-2.0971250534057617,"time":"2015-07-03 21","x":116.03023689428676,"y":40.753555589077223,"speed":3.41,"angle":127.91},{"xIncrement":1.7124414443969727,"yIncrement":-1.7712574005126953,"time":"2015-07-03 22","x":116.14032215247578,"y":40.677874298283591,"speed":2.46,"angle":135.97},{"xIncrement":2.2750329971313477,"yIncrement":-2.0577597618103027,"time":"2015-07-03 23","x":116.20882816878117,"y":40.615254282793515,"speed":3.07,"angle":132.13}
		]},
		{"zlevel":3,"grdCollection":[{"xIncrement":-3.7815532684326172,"yIncrement":6.6538496017456055,"time":"2015-07-03 00","x":116.17,"y":40.286499999999819,"speed":7.65,"angle":-29.61},{"xIncrement":-2.8784422874450684,"yIncrement":6.15548849105835,"time":"2015-07-03 01","x":116.02767117709736,"y":40.515518611046247,"speed":6.8,"angle":-25.06},{"xIncrement":-2.9474549293518066,"yIncrement":5.6348714828491211,"time":"2015-07-03 02","x":115.92232622249655,"y":40.725554072016664,"speed":6.36,"angle":-27.61},{"xIncrement":-2.1737170219421387,"yIncrement":2.9053494930267334,"time":"2015-07-03 03","x":115.81194777234789,"y":40.918289471800804,"speed":3.63,"angle":-36.8},{"xIncrement":-0.037795398384332657,"yIncrement":1.0398654937744141,"time":"2015-07-03 04","x":115.72644004190876,"y":41.019080172654526,"speed":1.04,"angle":-2.08},{"xIncrement":0.22569037973880768,"yIncrement":0.74140971899032593,"time":"2015-07-03 05","x":115.72799278268357,"y":41.053410749448048,"speed":0.77,"angle":16.93},{"xIncrement":0.11300491541624069,"yIncrement":0.59889376163482666,"time":"2015-07-03 06","x":115.7400919580961,"y":41.077295516297447,"speed":0.61,"angle":10.69},{"xIncrement":0.69680756330490112,"yIncrement":0.22595450282096863,"time":"2015-07-03 07","x":115.74685377629548,"y":41.096747701993756,"speed":0.73,"angle":72.03},{"xIncrement":0.61058723926544189,"yIncrement":-0.40107715129852295,"time":"2015-07-03 08","x":115.77787311460797,"y":41.102558412884179,"speed":0.73,"angle":123.3},{"xIncrement":0.3711249828338623,"yIncrement":-1.1216319799423218,"time":"2015-07-03 09","x":115.80319995161489,"y":41.0879259980923,"speed":1.18,"angle":161.69},{"xIncrement":0.36805993318557739,"yIncrement":-1.4229099750518799,"time":"2015-07-03 10","x":115.81586644652893,"y":41.050128403859567,"speed":1.47,"angle":165.5},{"xIncrement":0.067591331899166107,"yIncrement":-1.1107203960418701,"time":"2015-07-03 11","x":115.82745509312628,"y":41.002406785553489,"speed":1.11,"angle":176.52},{"xIncrement":0.34111273288726807,"yIncrement":-1.2195612192153931,"time":"2015-07-03 12","x":115.82694543601644,"y":40.965662922450448,"speed":1.27,"angle":164.37},{"xIncrement":0.36319857835769653,"yIncrement":-0.93166869878768921,"time":"2015-07-03 13","x":115.83798059042476,"y":40.924681316207042,"speed":1.0,"angle":158.7},{"xIncrement":0.23839302361011505,"yIncrement":-0.25697818398475647,"time":"2015-07-03 14","x":115.85086101941658,"y":40.893125040444431,"speed":0.35,"angle":137.15},{"xIncrement":0.41448664665222168,"yIncrement":-0.068165391683578491,"time":"2015-07-03 15","x":115.86041413384191,"y":40.88409357710168,"speed":0.42,"angle":99.34},{"xIncrement":0.60312080383300781,"yIncrement":0.19035080075263977,"time":"2015-07-03 16","x":115.87819994160161,"y":40.880867445604807,"speed":0.63,"angle":72.48},{"xIncrement":0.82160145044326782,"yIncrement":0.405197411775589,"time":"2015-07-03 17","x":115.90498303112203,"y":40.885711895435271,"speed":0.92,"angle":63.75},{"xIncrement":1.0338481664657593,"yIncrement":0.22008734941482544,"time":"2015-07-03 18","x":115.94192999988211,"y":40.89711222220803,"speed":1.06,"angle":77.98},{"xIncrement":1.4054450988769531,"yIncrement":-0.25019404292106628,"time":"2015-07-03 19","x":115.98751954760108,"y":40.901897540165265,"speed":1.43,"angle":100.09},{"xIncrement":2.0038764476776123,"yIncrement":-1.2169408798217773,"time":"2015-07-03 20","x":116.04775987855071,"y":40.890281954766316,"speed":2.34,"angle":121.27},{"xIncrement":2.7252078056335449,"yIncrement":-1.8439526557922363,"time":"2015-07-03 21","x":116.13087759668844,"y":40.845335385230655,"speed":3.29,"angle":124.08},{"xIncrement":3.2695357799530029,"yIncrement":-2.2587566375732422,"time":"2015-07-03 22","x":116.24319038304071,"y":40.777900642961278,"speed":3.97,"angle":124.64},{"xIncrement":3.446643590927124,"yIncrement":-3.5112466812133789,"time":"2015-07-03 23","x":116.3775936029144,"y":40.695337604482646,"speed":4.92,"angle":135.53}
		]}
	]}];

	// 计算风向线
	var dd = data[0].result[0].grdCollection;
	for (i=0; i<dd.length; i++) {
		var a = dd[i].angle/180*Math.PI;
		// var a = (dd[i].angle + 180)/180*Math.PI;
		dd[i].u = Math.cos(a) * dd[i].speed;
		// dd[i].v = Math.sin(a) * dd[i].speed;
		dd[i].v = Math.sin(a) * dd[i].speed * -1;
		// console.log(dd[i].angle + " : " + dd[i].u + " , " + dd[i].v);
	}

	var pp = 0;
	var inPath = false;

	var view = new ol.View({
		projection: pj,
		resolution: 200,
		// resolutions: [75, 400],
		zoom: 10,
		// minZoom: 7,
		// maxZoom: 11,
		center: ol.proj.fromLonLat([116, 39]),
		extent: ol.proj.transformExtent ([114.8232, 38.3107, 118.5672, 40.7607], ol.proj.get('EPSG:4326'), ol.proj.get('EPSG:3857'))
	});

	var map = new ol.Map({
		layers: [
			ll,
			img
		],
		target: 'map',
		view: view
		// controls: [new ol.control.Zoom ({
		// 	className: "zoom",
		// 	target: "zoom"
		// })]
	});


// 	var cav = document.createElement("cavas");
// 	cav.className = "cav";
// 	map.getViewport().appendChild(cav);
// // alert(cav.width + " , " + cav.height);
// 	cav.width = cav.clientWidth;
// 	cav.height = cav.clientHeight;
// // alert(cav.width + " , " + cav.height);
// // console.log (cav);
// 	var ctx = cav.getContext("2d");

	var ctx = map.getViewport().firstChild.getContext("2d");
// console.log (ctx);

	var mp = [-1,-1];
	map.on ("pointermove", function(evt) {
		mp = evt.pixel;
		// dddd();
	});

	var dddd = function (evt) {
		// 单点测试
		ctx.fillStyle='rgba(255,0,0,1)';
		// var p = map.getPixelFromCoordinate( ol.proj.fromLonLat ([dd[0].x, dd[0].y]) );
		var p = map.getPixelFromCoordinate( ol.proj.transform([dd[0].x, dd[0].y], 'EPSG:4326', 'EPSG:3857') );
console.log (p);
		ctx.beginPath();
		ctx.arc(p[0], p[1], 10, 0, 2*Math.PI);
		ctx.fill();
/*
		var d = [];
		var i = 0;

		// 计算坐标
		var r = view.getResolution();
		var w = 3000/ r;
		if (w>9) {
			w=9;
		} else if (w < 3) {
			w =3;
		}
		for (i=0; i<dd.length; i++) {
			var di = {};
			var p = map.getPixelFromCoordinate( ol.proj.fromLonLat ([dd[i].x, dd[i].y]) );
			di.x = p[0];
			di.y = p[1];
			di.time = dd[i].time;
			di.speed = dd[i].speed;
			di.angle = dd[i].angle;
			di.u = dd[i].u / r * 5000;
			di.v = dd[i].v / r * 5000;
			d.push(di);
		}

		// 画轨迹
		inPath = false;
		// var ctx = evt.context;
		ctx.lineWidth=w/3;
		ctx.lineJoin='round';
		ctx.strokeStyle='rgba(255,0,0,1)';
		ctx.beginPath();
		ctx.moveTo(d[0].x, d[0].y);
		for (i=1; i<d.length; i++) {
			// var x1 = d[i-1].x + d[i-1].u;
			// var y1 = d[i-1].y + d[i-1].v;
			// var x2 = d[i].x - d[i].u;
			// var y2 = d[i].y - d[i].v;
			// ctx.bezierCurveTo(x1, y1, x2, y2, d[i].x, d[i].y);
			// ctx.quadraticCurveTo(x1, y1, d[i].x, d[i].y);
			ctx.lineTo(d[i].x, d[i].y);
		}
		ctx.stroke();
*/
/*
		inPath = ctx.isPointInPath(mp[0], mp[1]);

		// 节点范围
		ctx.beginPath();
		var nodeW = w+4;
		for (i=0; i<d.length; i++) {
			ctx.rect(d[i].x-nodeW/2,d[i].y-nodeW/2,nodeW,nodeW);
		}
		var inNode = ctx.isPointInPath(mp[0], mp[1]);

		if (inPath || inNode) {
			// 画节点
			ctx.fillStyle='rgba(0,255,255,1)';
			ctx.fill();
			// ctx.stroke();

			// 画风向
			ctx.lineWidth=2;
			ctx.strokeStyle='rgba(0,255,0,1)';
			for (i=0; i<d.length; i++) {
				ctx.beginPath();
				ctx.moveTo(d[i].x, d[i].y);
				ctx.lineTo(d[i].x + d[i].u, d[i].y + d[i].v);
				ctx.stroke();
			}

			// 判断节点是否激活
			if (inNode) {
				var inNodeIndex = -1;
				for (i=0; i<d.length; i++) {
					var x = Math.abs(mp[0] - d[i].x);
					var y = Math.abs(mp[1] - d[i].y);
					if (x<=nodeW/2 && y<=nodeW/2) {
						inNodeIndex = i;
						// console.log(i);
						nodeW += pp*30+1;

						ctx.fillStyle="black";
						ctx.font="20px Verdana";
						ctx.fillText (d[i].time, d[i].x + 30, d[i].y);

						ctx.beginPath();
						ctx.strokeStyle='rgba(255,0,0,1)';
						ctx.rect(d[i].x-nodeW/2,d[i].y-nodeW/2,nodeW,nodeW);
						ctx.stroke();
						pp += 0.05;
						break;
					}
				}
			}
		} else {
			// 画动画
			ctx.fillStyle='rgba(0,255,0,1)';
			for (i=1; i<d.length; i++) {
				var x = (d[i].x - d[i-1].x) * pp + d[i-1].x;
				var y = (d[i].y - d[i-1].y) * pp + d[i-1].y;
				ctx.beginPath();
				ctx.arc(x, y, w, 0, 2*Math.PI);
				ctx.fill();
			}
			pp += 0.05;
		}

		if (pp > 1) {
			pp = 0;
		}
*/
		// map.render();

		// console.log(view.getResolution());
		// console.log(view.getZoom());
		// console.log(map.getSize());
		// console.log(pj.getMetersPerUnit());
		// console.log( ol.proj.toLonLat (map.getCoordinateFromPixel ([0,0])) );
	};

	img.on("postcompose", dddd);

	// map.on("moveend", dddd);

	// map.on("pointerdrag", dddd);

	// 测试 moveend 事件
	// 测试 singleclick 事件

	// view.fit( ol.proj.transformExtent ([114.8232, 38.3107, 118.5672, 40.7607], ol.proj.get('EPSG:4326'), ol.proj.get('EPSG:3857')) );
	// view.fit( map.getSize() );

	</script>
</html>
