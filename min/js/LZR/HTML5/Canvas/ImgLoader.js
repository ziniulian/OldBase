LZR.HTML5.loadJs([LZR.HTML5.jsPath+"HTML5/util/Event.js",LZR.HTML5.jsPath+"util/expand/json2.js"]);LZR.HTML5.Canvas.ImgLoader=function(a){this.imgs=[];this.wsId=this.wsCount=this.fact=this.expect=0;this.isBusy=!1;a&&(this.callback=a)};LZR.HTML5.Canvas.ImgLoader.prototype.className="LZR.HTML5.Canvas.ImgLoader";LZR.HTML5.Canvas.ImgLoader.prototype.version="0.0.2";
LZR.HTML5.Canvas.ImgLoader.prototype.add=function(a,c,e,b){var d;!isNaN(c)&&this.imgs[c]?(d=this.imgs[c],LZR.HTML5.Util.Event.removeEvent(d,"load",d.LZR_cb)):d=document.createElement("IMG");d.LZR_cb=LZR.bind(this,this.finish,c,d,e,b);LZR.HTML5.Util.Event.addEvent(d,"load",d.LZR_cb);this.isBusy=!0;this.expect++;d.src=a};LZR.HTML5.Canvas.ImgLoader.prototype.del=function(a){this.imgs.splice(a,1)};
LZR.HTML5.Canvas.ImgLoader.prototype.finish=function(a,c,e,b){isNaN(a)?this.imgs.push(c):this.imgs[a]=c;e?e(a,c,b):this.callback(a,c,b);this.fact++;this.expect<=this.fact&&(this.isBusy=!1,this.finished())};
LZR.HTML5.Canvas.ImgLoader.prototype.addByWebSocket=function(a,c,e){this.closeWebSocket();this.websocket=new WebSocket(a.url);this.websocket.onopen=LZR.bind(this,function(){this.fact=this.expect=this.wsId=0;this.isBusy=!0;this.websocket.send(JSON.stringify(c))});this.websocket.onclose=LZR.bind(this,function(){this.expect=this.wsId;0===this.wsId&&this.finished()});this.websocket.onmessage=LZR.bind(this,function(b){b=JSON.parse(b.data);switch(b.state){case "0":this.add(a.pre+b[a.fld],this.wsId,e,b);
this.wsId++;break;case "5":this.expect=b.count,this.wsId=0,this.onCount(this.wsCount,b)}});this.websocket.onerror=function(){}};LZR.HTML5.Canvas.ImgLoader.prototype.closeWebSocket=function(){this.websocket&&(this.websocket.close(),this.websocket=null)};LZR.HTML5.Canvas.ImgLoader.prototype.callback=function(){};LZR.HTML5.Canvas.ImgLoader.prototype.onCount=function(){};LZR.HTML5.Canvas.ImgLoader.prototype.finished=function(){};
