window.ol||(LZR.HTML5.loadJs([LZR.HTML5.jsPath+"HTML5/expand/ol3/ol.js"]),LZR.HTML5.loadCss([LZR.HTML5.jsPath+"HTML5/expand/ol3/ol.css"]));LZR.HTML5.loadJs([LZR.HTML5.jsPath+"util/Graphics.js"]);
LZR.HTML5.Bp.OpenLayers.Orbit=function(a){a.map&&(this.map=a.map,this.initData(a.data),this.sourceColor=a.sourceColor?a.sourceColor:"red",this.sourceSize=a.sourceSize?a.sourceSize:20,this.sourceWidth=a.sourceWidth?a.sourceWidth:2,this.sourceSpeed=a.sourceSpeed?a.sourceSpeed:0.01,this.orbitAnimationColor=this.initColor(a.orbitAnimationColor),this.orbitShadowColor=this.initColor(a.orbitShadowColor),this.orbitColor=this.initColor(a.orbitColor),this.orbitBlur=a.orbitBlur?a.orbitBlur:20,this.orbitScale=
a.orbitScale?a.orbitScale:0.5,this.orbitSpeed=a.orbitSpeed?a.orbitSpeed:0.01,this.nodeShadowColor=a.nodeShadowColor?a.nodeShadowColor:this.orbitShadowColor,this.nodeColor=a.nodeColor?a.nodeColor:this.orbitColor,this.nodeBlur=a.nodeBlur?a.nodeBlur:this.orbitBlur,this.nodeScale=a.nodeScale?a.nodeScale:3E3,this.nodeMax=a.nodeMax?a.nodeMax:8,this.nodeMin=a.nodeMin?a.nodeMin:6,a.showNode?this.setShowNode(a.showNode):this.setShowNode(0),this.title=a.title?a.title:document.createElement("div"),this.titleArea=
a.titleArea?a.titleArea:0,this.curentPosition=[-1,-1],this.nodeOverIndex=this.orbitOverIndex=-1,this.ctx=this.canvas=this.layer=null,this.gp=new LZR.Util.Graphics)};LZR.HTML5.Bp.OpenLayers.Orbit.prototype.className="LZR.HTML5.Bp.OpenLayers.Orbit";LZR.HTML5.Bp.OpenLayers.Orbit.prototype.version="0.0.4";
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.initColor=function(a){var b=0,e=[];if(a){if("string"==LZR.HTML5.Util.getClassName(a)){for(b=0;b<this.data.length;b++)e.push(a);return e}e=a;b=e.length;isNaN(b)&&(b=0)}for(;b<this.data.length;b++)a="rgba("+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", "+Math.floor(255*Math.random())+", 1)",e.push(a);return e};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.init=function(){null===this.layer&&(this.layer=new ol.layer.Image({source:new ol.source.ImageStatic({url:"",imageExtent:[0,0,0,0]})}),this.map.on("pointermove",LZR.bind(this,function(a){this.curentPosition=a.pixel})),this.layer.on("postcompose",LZR.bind(this,function(){if(null===this.ctx){this.canvas=document.createElement("canvas");var a=this.map.getViewport();a.insertBefore(this.canvas,a.childNodes[1]);this.canvas.style.width="100%";this.canvas.style.height=
"100%";this.canvas.style.position="absolute";this.canvas.style.top="0";this.canvas.style.left="0";this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;LZR.HTML5.Util.Event.addEvent(window,"resize",LZR.bind(this,function(){this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight}),!1);this.ctx=this.canvas.getContext("2d");a=this.title.style;a.visibility="hidden";a.position="relative";a=this.map.getTargetElement();a.appendChild(this.title);
this.mapW=a.scrollWidth;this.mapH=a.scrollHeight;this.titleNdi=this.titleObi=-1}this.flush(this.ctx)&&this.map.render()})),this.map.addLayer(this.layer))};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.flush=function(a){a.clearRect(0,0,this.canvas.width,this.canvas.height);var b=this.map.getView().getResolution();this.calcNodeWidth(b);for(var e=this.nodeOverIndex=this.orbitOverIndex=-1,c=0;c<this.data.length;c++)if(this.data[c].visible){var e=c,d=this.data[c].nodes;this.calcData(d,b);this.drawOrbitPath(d,a,c);this.calcNode(d,a,c);if(this.orbitOverIndex===c){if(this.drawNode(d,a,c),0<=this.nodeOverIndex&&(this.titleObi!==this.orbitOverIndex||this.titleNdi!==
this.nodeOverIndex)){this.titleObi=this.orbitOverIndex;this.titleNdi=this.nodeOverIndex;var f=this.title.style;f.left=this.curentPosition[0]+"px";f.top=this.curentPosition[1]-this.mapH+"px";this.onShowTitle(this.title,d[this.titleNdi],this.titleObi,this.titleNdi);"hidden"===f.visibility&&(f.visibility="visible")}}else this.ap[c]+=this.orbitSpeed,1<this.ap[c]&&(this.ap[c]=0);this.drawOrbit(d,a,c)}return-1!==e?(this.drawSource(a,e),-1!==this.titleNdi&&-1===this.nodeOverIndex&&(this.titleNdi=this.titleObi=
-1,this.title.style.visibility="hidden"),!0):!1};LZR.HTML5.Bp.OpenLayers.Orbit.prototype.initData=function(a){this.data=[];this.ap=[];if(a)for(var b=0;b<a.length;b++){var e={visible:!0};e.zlevel=a[b].zlevel;e.nodes=[];for(var c=a[b].grdCollection,d=0;d<c.length;d++){var f={},g;for(g in c[d])f[g]=c[d][g];f.lon=c[d].x;f.lat=c[d].y;if(0<d){var h=e.nodes[d-1],j=f.y-h.y,k=f.x-h.x;h.lineAngle=Math.asin(j/Math.sqrt(j*j+k*k));0>k&&(h.lineAngle=Math.PI-h.lineAngle)}e.nodes.push(f)}this.data.push(e);this.ap.push(0)}};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.calcNodeWidth=function(a){this.nodeWidth=this.nodeScale/a;this.nodeWidth>this.nodeMax?this.nodeWidth=this.nodeMax:this.nodeWidth<this.nodeMin&&(this.nodeWidth=this.nodeMin)};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.calcData=function(a,b){for(var e=0,c=0;c<a.length;c++){var d=a[c],f=this.calcPixel(d.lon,d.lat);d.x=f[0];d.y=f[1];d.u=d.su/b*this.windScale;d.v=d.sv/b*this.windScale;if(0<c){var f=a[c-1],g=d.y-f.y,d=d.x-f.x;f.lineLong=Math.sqrt(g*g+d*d);f.lineAngle=Math.asin(g/f.lineLong);0>d&&(f.lineAngle=Math.PI-f.lineAngle);f.lineLong>e&&(e=f.lineLong)}}a.max=e};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.drawOrbitPath=function(a,b,e){var c=this.nodeWidth*this.orbitScale;b.save();b.fillStyle=this.orbitColor[e];b.shadowColor=this.orbitShadowColor[e];b.shadowBlur=this.orbitBlur;b.beginPath();for(var d=0;d<a.length-1;d++){var f=this.gp.calcTransform(a[d].lineAngle,1,1,a[d].x,a[d].y);b.setTransform(f[0],f[1],f[2],f[3],f[4],f[5]);b.moveTo(0,c);b.arc(0,0,c,Math.PI/2,3*Math.PI/2);b.lineTo(a[d].lineLong,-c);b.arc(a[d].lineLong,0,c,-Math.PI/2,Math.PI/2);b.closePath()}b.fill();
b.restore();-1===this.orbitOverIndex&&b.isPointInPath(this.curentPosition[0],this.curentPosition[1])&&(this.orbitOverIndex=e)};LZR.HTML5.Bp.OpenLayers.Orbit.prototype.calcNode=function(a,b,e){for(var c=this.nodeWidth+this.titleArea,d=2*Math.PI,f=0;f<a.length;f++)if(b.beginPath(),b.arc(a[f].x,a[f].y,c,0,d),(-1===this.orbitOverIndex||this.orbitOverIndex===e)&&b.isPointInPath(this.curentPosition[0],this.curentPosition[1])){this.orbitOverIndex=e;this.nodeOverIndex=f;break}};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.drawNode=function(a,b,e){var c=0,d=a.length;switch(this.showNode){case 1:c++;break;case 2:d--}var f=this.nodeWidth,g=2*Math.PI;b.save();b.fillStyle=this.nodeColor[e];b.shadowColor=this.nodeShadowColor[e];b.shadowBlur=this.nodeBlur;b.beginPath();for(e=c;e<d;e++)b.arc(a[e].x,a[e].y,f,0,g),b.closePath();b.fill();b.restore()};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.drawOrbit=function(a,b,e){b.save();b.fillStyle=this.orbitAnimationColor[e];b.beginPath();for(i=1;i<a.length;i++){var c=(a[i].x-a[i-1].x)*this.ap[e]+a[i-1].x,d=(a[i].y-a[i-1].y)*this.ap[e]+a[i-1].y,f=0.8*(a[i-1].lineLong/a.max);0.2>f&&(f=0.2);f*=this.nodeWidth;c=this.gp.calcTransform(a[i-1].lineAngle,f,f,c,d);b.setTransform(c[0],c[1],c[2],c[3],c[4],c[5]);b.moveTo(0,0);b.lineTo(-1,1);b.lineTo(3,0);b.lineTo(-1,-1);b.closePath()}b.fill();b.restore()};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.drawSource=function(a,b){var e,c,d;c=this.data[b].nodes;switch(this.showNode){case 2:d=c.length-1;e=c[d].x;c=c[d].y;0.05>this.apSource&&(this.apSource=1);break;default:e=c[0].x,c=c[0].y,1<this.apSource&&(this.apSource=0.05)}d=this.sourceSize*this.apSource;a.save();a.lineWidth=this.sourceWidth;a.strokeStyle=this.sourceColor;a.beginPath();a.arc(e,c,d,0,2*Math.PI);a.stroke();a.restore();this.apSource+=this.sourceSpeed};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.setVisible=function(a,b){var e=this.data[a];e&&(e.visible=b);b&&this.map.render()};LZR.HTML5.Bp.OpenLayers.Orbit.prototype.setShowNode=function(a){this.showNode=a;2===this.showNode?(this.apSource=1,0<this.sourceSpeed&&(this.sourceSpeed*=-1)):(this.apSource=0,0>this.sourceSpeed&&(this.sourceSpeed*=-1))};LZR.HTML5.Bp.OpenLayers.Orbit.prototype.calcPixel=function(a,b){return this.map.getPixelFromCoordinate(ol.proj.fromLonLat([a,b]))};
LZR.HTML5.Bp.OpenLayers.Orbit.prototype.onShowTitle=function(){};
